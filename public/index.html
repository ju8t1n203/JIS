<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <meta charset="UTF-8" />
    <title>Justin Inventory System</title>
    <style>
      
      body {
        font-family: "Roboto", sans-serif;
        font-size: 16pt;
        font-weight: 300;
        font-style: normal;
        background-color: #999999;
        position: relative; /* Required for ::before layering */
        overflow: hidden;
      }

      body::before {
        background-image: url('favicon.ico');
        background-size: 256px 300px;
        background-position: bottom 25px right 25px;
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-repeat: no-repeat;
        z-index: -1; 
        pointer-events: none;
      }

      .tabs.main-tabs {
        display: flex;
        gap: 1px;
        margin-bottom: 0px;
      }

      .tab {
        padding: 10px 16px;
        background: #e0e0e0;
        border-radius: 15px 15px 0 0;
        cursor: pointer;
      }

      .tab.active {
        color: #FFFFFF;
        background: #005178;
      }

      #mainContent {
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 0 15px 15px 15px;
        min-height: 200px;
        background-color: #fafafa;
      }
      
    </style>
  </head>

  <body>

    <h2>JIST</h2>

    <div class="tabs main-tabs">
      <div class="tab active" data-tab="search">Search</div>
      <div class="tab" data-tab="consume">Consume</div>
      <div class="tab" data-tab="restock">Restock</div>
      <div class="tab" data-tab="addremove">Add/Remove</div>
      <div class="tab" data-tab="edit">Edit</div>
      <div class="tab" data-tab="picklist">Pick List</div>
    </div>

    <div id="mainContent">Loading...</div>

    <script src="/js/editcombo.js"></script>
    <script src="/js/subtabs.js"></script>
    <script src="/js/EditLoc.js"></script>
    <script src="/js/adcombo.js"></script>
    <script src="/js/addata.js"></script>
    <script src="/js/editcat.js"></script>
    <script src="/js/edititem.js"></script>
    <script src="/js/searchdb.js"></script>
    <script src="/js/searchbtn.js"></script>
    <script src="/js/searchcombo.js"></script>
    <script src="/js/changeinventory.js"></script>
    <script src="/js/PickLogic.js"></script>

    <script>
      //main tab logic
      const mainTabs = document.querySelectorAll('.tabs.main-tabs .tab');
      const mainContent = document.getElementById('mainContent');

      const tabMap = {
        search: 'search.html',
        consume: 'consume.html',
        restock: 'restock.html',
        addremove: 'addremove.html',
        edit: 'edit.html',
        picklist: 'picklist.html'
      };
      
      let cachedPicklistHTML = null;
      let reloadPicklist = false;

      mainTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const currentActive = document.querySelector('.tabs.main-tabs .tab.active');
          const currentTabPath = tabMap[currentActive?.dataset.tab];

          //if leaving picklist tab save the picklist HTML
          if (currentTabPath === 'picklist.html') {
            cachedPicklistHTML = mainContent.innerHTML;
            reloadPicklist = false;
            console.log('[cache] Picklist snapshot saved before tab switch');
          }
          //change active tab
          mainTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const page = tabMap[tab.dataset.tab];
          loadTab(page);
        });
      });

      //on initial load, default to search tab
      window.addEventListener('DOMContentLoaded', () => {
        loadTab('search.html');
      });

      function loadTab(tabPath) {

        //if picklist tab and cached picklist HTML exists, use it
        if (tabPath === 'picklist.html' && cachedPicklistHTML && !reloadPicklist) {
          mainContent.innerHTML = cachedPicklistHTML;
          if (typeof load === 'function') load();
          console.log('[loadTab] Picklist page reused from cache');
          return;
        }

        //gets the html and  scripts for the selected tab
        fetch(`tab-pages/${tabPath}`)
          .then(res => res.text())
          .then(html => {
            mainContent.innerHTML = html;

            setTimeout(() => {
              switch (tabPath) {
                case 'search.html':
                  if (typeof searchdb === 'function') searchdb();
                  if (typeof setupInventoryBtnListeners === 'function') setupInventoryBtnListeners();
                  console.log('[loadTab] Search DB initialized');
                break;

                case 'consume.html':
                case 'restock.html':
                  if (typeof changeInventory === 'function') changeInventory();
                  console.log(`[loadTab] ${tabPath.replace('.html','')} page initialized`);
                break;

                case 'addremove.html':
                  if (typeof setupADcombo === 'function') setupADcombo();
                  if (typeof setupADdata === 'function') setupADdata();
                break;

                case 'edit.html':
                  if (typeof setupComboLogic === 'function') setupComboLogic();
                  if (typeof manipulateCategory === 'function') manipulateCategory();
                  if (typeof attachEditLocListener === 'function') attachEditLocListener();
                  if (typeof setupSubTabs === 'function') setupSubTabs();
                  if (typeof setupei === 'function') setupei();
                  console.log('[loadTab] Sub-tabs initialized');
                break;

                case 'picklist.html':
                  cachedPicklistHTML = mainContent.innerHTML;
                  reloadPicklist = false;
                  console.log('[loadTab] Picklist page rendered & cached');
                  if (typeof load === 'function') load();
                break;
              }
            }, 20);
          })
          .catch(err => {
            console.error(`‚ùå Failed to load ${tabPath}:`, err);
            mainContent.innerHTML = `<p style="color:red;">Could not load content. Try again.</p>`;
        });
      }
    </script>
  </body>
</html>
